#!/bin/bash
run(){
  run_ioc ${1};
  tail -f /dev/null
}

run_ioc(){
    # Params:
    # :1 : CMD_KEY
    # @todo: Make this thing clear !!
    echo
    echo
    procServPort=${BASE_PROCSERV_PORT}
    for filename in $(ls ${TOP}/iocBoot/iocStreamDeviceIOC | sort  | grep -P "^${1}[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}:?[0-9]{0,5}\.cmd$"); do
        ip=$(echo $filename | sed -e "s/${1}//" -e "s/\.cmd//")
        if [[ ${ip} =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}:[0-9]{1,5}$ ]]; then
                procServPort=$((procServPort + 1))
                set -x
                procServ --allow -L  log/${filename}  --chdir ${TOP}/iocBoot/iocStreamDeviceIOC ${procServPort} ${TOP}/iocBoot/iocStreamDeviceIOC/${filename}
                set +x
        fi
    done
    export BASE_PROCSERV_PORT=${procServPort}
}
